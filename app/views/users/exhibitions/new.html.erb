<div class="container exhibition-new">
	<div class="row">
			<h1>個展開催</h1>
			<div class="error-box">
				<% if @exhibition.errors.any? %>
			    	<h2><%= @exhibition.errors.count %>件のエラーがあります</h2>
			    	<ul>
			    	<% @exhibition.errors.full_messages.each do |message| %>
			    	<li><%= message %></li>
			    	<% end %>
			    <% end %>
			</div>
<!-- 個展概要フォーム -->
		<% if user_signed_in? %>
			<%= form_with model: @exhibition, url: {controller: 'exhibitions', action: 'create' } do |f| %>
				<label>タイトル</label><br>
				<%= f.text_field :title %><br>
				<label>個展概要</label><br>
				<%= f.text_area :caption %><br>


<!-- 作品フォーム -->
		<div class = "col l12 m12 s12">
			<h2>掲載作品</h2>
			<%= f.nested_fields_for :works, wrapper_tag: :div do |field| %>
				<div class = "col l4 m12 s12 form">
					<label>画像タイトル</label><br>
					<%= field.text_field :work_title %><br>
					<label>作品説明</label><br>
					<%= field.text_field :description %><br>
					<label>作品画像</label><br>
					<%= field.attachment_field :work_image, onchange: "previewFile(this)", class: 'preview_file'%><br>
						<img src="" class="work_prev" height="200" width="200" alt="Image preview" >
					  <!-- <div id="preview"></div> -->
					 <!-- ここでプレビュー -->
<!-- フォーム削除 -->
					<br><%= field.remove_nested_fields_link 'Delete' %>
				</div>
			<% end %>
		</div>
	</div>
<!-- フォーム追加・開催 -->
				<div class="row add-form">
					<div class = "col l12 m12 s12">
						<div class="col l5 m8 s6 offset-l10 offset-m8 offset-s8">
						<%= f.add_nested_fields_link :works, 'フォーム追加する', class: 'btn waves-effect waves-light', type: 'button'%>
						<%= button_tag '開催', class: 'btn waves-effect waves-green', type: 'button', onclick: 'submit();' %>
						</div>
					</div>
				</div>
			<% end %>
		<% end %>
	</div>
</div>

<script>
$(function() {
  var fieldsCount,
      maxFieldsCount = 4,
      $addLink = $('a.add_nested_fields_link');

  function toggleAddLink() {
    $addLink.toggle(fieldsCount <= maxFieldsCount)
  }

  $(document).on('fields_adding.nested_form_fields', function() {
    fieldsCount += 1;
    toggleAddLink();
  });

  $(document).on('fields_removing.nested_form_fields', function() {
    fieldsCount -= 1;
    toggleAddLink();
  });

  // count existing nested fields after page was loaded
  fieldsCount = $('form .fields').length;
  toggleAddLink();
})

</script>

<!-- プレビュー -->
<script>
	// document.getElementsByClassName("preview_file").onchange = previewFile;
	function previewFile(obj) {
　　 console.log(obj)
    // console.log(obj.find(".work_prev"))
    console.log(document.querySelector(".work_prev"))
    console.log(document.querySelector('input[type=file]').files)
	var preview = $(".work_prev")[obj.name[29]];
	var file    = obj.files[0];
	var reader  = new FileReader();

	reader.addEventListener("load", function () {
    preview.src = reader.result;
  }, false);


	if (file) {
		reader.readAsDataURL(file);
	}
}
</script>
<!-- <script>
function previewFiles() {
  console.log(document.querySelector("#preview"))
  console.log(document.querySelector('input[type=file]').files)

  var preview = document.querySelector('#preview');
  var files   = document.querySelector('input[type=file]').files;

  function readAndPreview(file) {

    // Make sure `file.name` matches our extensions criteria
    if ( /\.(jpe?g|png|gif)$/i.test(file.name) ) {
      var reader = new FileReader();

      reader.addEventListener("load", function () {
        var image = new Image();
        image.height = 100;
        image.title = file.name;
        image.src = this.result;
        preview.appendChild( image );
      }, false);

      reader.readAsDataURL(file);
    }

  }

  if (files) {
    [].forEach.call(files, readAndPreview);
  }

}
</script> -->

<!-- 複数プレビュー -->
<!-- <script>
	function previewFile() {
	var preview = document.querySelector("#work_prev");
	// var file    = document.querySelector('input[type=file]').files[i];
	var file_length = document.querySelector('input[type=file]').files.length;

	for( var i=0,l = file_length.length; l > i; i++ ) {

	var reader  = new FileReader();

	reader.addEventListener("load", function () {
    preview.src = reader.result;
  	}, false)
	}


	if (file) {
		reader.readAsDataURL(file_length[i]);
	}
}
</script> -->
